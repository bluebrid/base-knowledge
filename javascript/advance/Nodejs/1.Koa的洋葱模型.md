## Koa
Koa 的洋葱模型指的是以 **next()** 函数为分割点，先由**外到内**执行 Request 的逻辑，再由**内到外**执行 Response 的逻辑。通过洋葱模型，将多个中间件之间通信等变得更加可行和简单。其实现的原理并不是很复杂，主要是 compose 方法。

```javascript
const Koa = require('koa');
//Applications
const app = new Koa();
// 中间件1
app.use((ctx, next) => {
  console.log(1);
  next();
  console.log(2);
});
// 中间件 2 
app.use((ctx, next) => {
  console.log(3);
  next();
  console.log(4);
});
app.listen(9000, '0.0.0.0', () => {
    console.log(`Server is starting`);
});
```

```javascript
  use(fn) {
    if (typeof fn !== 'function') throw new TypeError('middleware must be a function!');
    if (isGeneratorFunction(fn)) {
      deprecate('Support for generators will be removed in v3. ' +
                'See the documentation for examples of how to convert old middleware ' +
                'https://github.com/koajs/koa/blob/master/docs/migration.md');
      fn = convert(fn);
    }
    debug('use %s', fn._name || fn.name || '-');
    this.middleware.push(fn);
    return this;
  }
```
![](https://pic1.zhimg.com/v2-e2e19352126f075152431ba52efbdba8_1440w.jpg?source=172ae18b)
![](https://pic4.zhimg.com/80/v2-99b874cf305bbfe6ecfcb2df1143dccb_720w.jpg)
![](https://pic3.zhimg.com/80/v2-95f4fcba6e7023f3f29d177922f60c0e_720w.jpg)