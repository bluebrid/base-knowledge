## [好未来数据中台 Node.js BFF 实践（一）](https://mp.weixin.qq.com/s?__biz=MzIyNDU2NTc5Mw==&mid=2247499969&idx=1&sn=dca1ffd503fccc98262ac3bad3206dcf&chksm=e80f8f8fdf780699900edd8bf9d809c8b06b58c741179941ad55d68fb79d8700a2dcb79ebbb3&mpshare=1&scene=24&srcid=0225JVbYe9zgf7fwEas6EjNx&sharer_sharetime=1645750364631&sharer_shareid=3efb78b5e058f0088976a184d31a463b#rd)

## [BFF 应用](https://juejin.cn/post/6855621776635789325)
1. 承担接口代理，转发
   > 1. 在开发环境，我们可以利用带来解决最常见的问题,比如<font color=red>跨域问题</font>
   > 2. 线上我们可以利用代理解决<font color=red>转发请求到多个服务器</font>
2. 承担接口聚合以及与DB无关的业务逻辑
   > 1. 我们可以利用接入层，处理<font color=red>缓存问题</font>
3. 接口<font color=red>限流</font>
   > 1. Nodejs 中间层，我们可以针对特定的接口和路由做限流操作
4. 可以完善整个操作链路的日志
   > 1. 如果我们一个平台调用多个服务资源，日志非常难以排查
   > 2. 我们可以利用NodeJS 做接入层， 完善整个操作日志链路，便于排查问题
5. 监控
6. 鉴权操作
> 1. <font color=red>只有一个中间层去鉴权，也是一种单一职责的实现</font>
> 1. 数据中台CAM提供统一的用户登录/登出服务
> 2. 客户端向数据中台进行登录，登录后返回JWT Token 
> 3. 访问其他的服务器中心携带JWT Token, 在Nodejs 服务层，进行Token鉴权
> 4. 访问其他的第三方的服务，请求数据
![](https://mmbiz.qpic.cn/mmbiz_png/Qkqt1soCUia1FAF8p9tOHUtddn5pM8mx48B8mib2BibWxQvS49aicxRA5kTEdqkyVPNLVmpMVScl9iamhcYUpLiaUoRA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)
7. 路由守卫配置
8. <font color=red>服务端渲染，以及模块注入</font>

## BFF(Backend of FrontEnd) 好处
1. 通过PC web自己的中间层，可以按照业务定制化接口，扩大前端的展现和能力范围
2. 中间层，由前端同学进行开发，是因为前端对展现和接口的功能更加的熟悉，避免了之前工作模式的接口需求的对接，沟通，联调时间
3. NodeJS 作为中间层，开发语言是Javascript，减少了学习成本
4. 中间层由前端同学进行开发， 即节约了成本，而且提高了前端同学的技术能力
5. 功能分离，减轻了模板的负担
6. 跨端的页面数据校验，代码逻辑，降低，无需因为信息统，终端的接入而重写校验
7. 终端进行数据校验，避免了，前端和后端都做校验的重复性工作，保证了数据的有效性同时降低了整个团队的工作量
8. 处理数据逻辑，解放了前端纪要做页面渲染又要些复杂逻辑的逻辑，使得页面开发人员更专注与页面得体验开发

## BFF带来的问题
1. 资源问题： Nodejs 需要单独一个服务器发布， 占用资源，尤其需要考虑QPS（每秒请求数）波动，需要服务器提供商考虑自动伸缩容性服务
2. 维护问题：多了一个服务，需要考虑稳定等问题，同时还会加深学习成本，前端同学需要学习掌握服务端的知识，如：数据库，服务器，并发等问题
3. 服务链路问题：之前只是当都调用对应的服务资源就可以，现在都是直接通过BFF请求，流程会变得繁琐
## 进程守护
1. <font color=red>K8S</font>普及之前，我们是用`PM2`进行进程守护
2. 使用这些工具，会占用额外的服务器资源<font color=red>CPU,内存等</font>
3. K8s <font color=red>探针</font> 完全可以取代PM2等进程守护工具
4. 两种存活检测探针<font color=red>HTTP和TCP</font>
   > 1. Http 探针本质上是向某个接口发起 Get 请求，响应成功状态码代表服务健康，否则判定为坏死重启 pod
   > 2. 对于Node服务，相当于是一次请求，<font color=red>所以需要NodeJS 服务提供一个专用的接口，如/health</font>,需要额外的工作，并且这个接口不应该记录日志
   > 3. TCP探针，<font color=red>本质上尝试与容器建立socket连接，成功表示服务器存活，否则判定为坏死重启Pod,对Nodejs服务本身没有依赖和影响</font>
只要在K8S平台进行配置就好
![](https://mmbiz.qpic.cn/mmbiz_png/Qkqt1soCUia1FAF8p9tOHUtddn5pM8mx4pcB8zvDbFiaY2LNeMx4Lj8IZcvHra4JN4gtnpicYen2lsPsiaJYShttog/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

## BFF架构
1. APP.js 入口文件
2. Router （Control）路由层
3. Service(逻辑处理)
4. Data Access Layer（数据交互层， Model层）
5. Views(Ejs模板文件,注入前端JS文件)
6. Middleware（中间件）
![](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/05c44877a7ec47839c27a72825785b4a~tplv-k3u1fbpfcp-zoom-in-crop-mark:1630:0:0:0.awebp?)
## [K8S](https://juejin.cn/post/6952331691524358174)